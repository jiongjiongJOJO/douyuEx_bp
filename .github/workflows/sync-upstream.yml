name: Sync Upstream and Build

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - master
    paths:
      - '.github/workflows/sync-upstream.yml'

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up upstream remote
      run: |
        git remote add upstream https://github.com/qianjiachun/douyuEx.git || true
        git fetch upstream

    - name: Check for upstream changes
      id: check-changes
      run: |
        # èŽ·å–å½“å‰åˆ†æ”¯å’Œä¸Šæ¸¸masteråˆ†æ”¯çš„æœ€æ–°commit
        LOCAL_COMMIT=$(git rev-parse HEAD)
        UPSTREAM_COMMIT=$(git rev-parse upstream/master)
        
        echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
        echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
        
        if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°"
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°"
        fi

    - name: Sync upstream changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        # é…ç½®gitç”¨æˆ·ä¿¡æ¯
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        
        # å¤‡ä»½å½“å‰çš„build-outputç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -d "build-output" ]; then
          echo "ðŸ”„ å¤‡ä»½çŽ°æœ‰çš„build-outputç›®å½•..."
          cp -r build-output build-output-backup
        fi
        
        # å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ–°
        echo "ðŸ”„ å°è¯•åˆå¹¶ä¸Šæ¸¸æ›´æ–°..."
        if git merge upstream/master --no-edit; then
          echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸æ›´æ–°"
        else
          echo "âš ï¸ åˆå¹¶å†²çªï¼Œä½¿ç”¨æ™ºèƒ½åŒæ­¥ç­–ç•¥"
          
          # ä¿å­˜é‡è¦æ–‡ä»¶
          IMPORTANT_FILES=()
          if [ -d "build-output" ]; then
            IMPORTANT_FILES+=("build-output")
          fi
          if [ -f ".github/workflows/sync-upstream.yml" ]; then
            IMPORTANT_FILES+=(".github")
          fi
          
          # å¤‡ä»½é‡è¦æ–‡ä»¶
          for item in "${IMPORTANT_FILES[@]}"; do
            if [ -e "$item" ]; then
              echo "ðŸ“¦ å¤‡ä»½é‡è¦æ–‡ä»¶: $item"
              cp -r "$item" "${item}-temp-backup"
            fi
          done
          
          # å¼ºåˆ¶é‡ç½®åˆ°ä¸Šæ¸¸
          git reset --hard upstream/master
          
          # æ¢å¤é‡è¦æ–‡ä»¶
          for item in "${IMPORTANT_FILES[@]}"; do
            if [ -d "${item}-temp-backup" ]; then
              echo "ðŸ”„ æ¢å¤é‡è¦æ–‡ä»¶: $item"
              rm -rf "$item" 2>/dev/null || true
              mv "${item}-temp-backup" "$item"
            fi
          done
        fi
        
        # æ¢å¤build-outputå¤‡ä»½ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if [ -d "build-output-backup" ]; then
          echo "ðŸ”„ æ¢å¤build-outputç›®å½•..."
          rm -rf build-output 2>/dev/null || true
          mv build-output-backup build-output
        fi

    - name: Setup Node.js
      if: steps.check-changes.outputs.changes_detected == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: npm install

    - name: Build project and manage directories
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        echo "ðŸ“Š åŒæ­¥åŽçš„ç›®å½•çŠ¶æ€:"
        echo "ðŸ”¸ å½“å‰distç›®å½•:"
        if [ -d "dist" ]; then
          echo "  å­˜åœ¨ (æ¥è‡ªä¸Šæ¸¸)"
          ls -la dist/ | head -3
        else
          echo "  ä¸å­˜åœ¨"
        fi
        
        echo "ðŸ”¸ å½“å‰build-outputç›®å½•:"
        if [ -d "build-output" ]; then
          echo "  å­˜åœ¨ (ä¹‹å‰çš„æž„å»º)"
          ls -la build-output/ | head -3
        else
          echo "  ä¸å­˜åœ¨"
        fi
        
        # ä¿å­˜ä¸Šæ¸¸çš„distç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        UPSTREAM_DIST_EXISTS=false
        if [ -d "dist" ]; then
          echo "ðŸ”„ ä¿å­˜ä¸Šæ¸¸distç›®å½•..."
          cp -r dist dist-upstream-original
          UPSTREAM_DIST_EXISTS=true
          echo "âœ… ä¸Šæ¸¸distç›®å½•å·²ä¿å­˜"
        fi
        
        # è¿è¡Œæž„å»º - è¿™ä¼šåˆ›å»ºæˆ–è¦†ç›–distç›®å½•
        echo "ðŸ”¨ å¼€å§‹æž„å»ºForkç‰ˆæœ¬..."
        npm run build
        
        # æ£€æŸ¥æž„å»ºæ˜¯å¦æˆåŠŸ
        if [ -d "dist" ] && [ -f "dist/douyuex.js" ]; then
          echo "âœ… Forkç‰ˆæœ¬æž„å»ºæˆåŠŸ"
          ls -la dist/
          
          # å°†Forkæž„å»ºç»“æžœå¤åˆ¶åˆ°build-output
          cp -r dist build-output
          echo "âœ… Forkæž„å»ºç»“æžœå·²ä¿å­˜åˆ°build-output/"
          
          # æ¢å¤ä¸Šæ¸¸çš„distç›®å½•
          if [ "$UPSTREAM_DIST_EXISTS" == "true" ]; then
            echo "ðŸ”„ æ¢å¤ä¸Šæ¸¸åŽŸå§‹distç›®å½•..."
            rm -rf dist
            mv dist-upstream-original dist
            echo "âœ… ä¸Šæ¸¸distç›®å½•å·²æ¢å¤"
          else
            echo "â„¹ï¸ ä¸Šæ¸¸æ²¡æœ‰distç›®å½•ï¼Œä¿ç•™æž„å»ºçš„distç›®å½•"
          fi
        else
          echo "âŒ æž„å»ºå¤±è´¥"
          # å¦‚æžœæž„å»ºå¤±è´¥ï¼Œæ¢å¤ä¸Šæ¸¸dist
          if [ "$UPSTREAM_DIST_EXISTS" == "true" ]; then
            rm -rf dist 2>/dev/null || true
            mv dist-upstream-original dist
            echo "ðŸ”„ å·²æ¢å¤ä¸Šæ¸¸distç›®å½•"
          fi
          exit 1
        fi
        
        # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
        echo ""
        echo "ðŸ“Š æœ€ç»ˆç›®å½•çŠ¶æ€:"
        echo "ðŸ”¸ dist/ (ä¸Šæ¸¸åŽŸç‰ˆ):"
        if [ -d "dist" ]; then
          ls -la dist/ | head -3
        else
          echo "  ä¸å­˜åœ¨"
        fi
        echo "ðŸ”¸ build-output/ (Forkæž„å»ºç‰ˆæœ¬):"
        if [ -d "build-output" ]; then
          ls -la build-output/ | head -3
        else
          echo "  ä¸å­˜åœ¨"
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          # æäº¤æ›´æ”¹
          git commit -m "ðŸ¤– è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç å¹¶æž„å»º ($(date '+%Y-%m-%d %H:%M:%S'))"
          
          # æŽ¨é€åˆ°origin
          git push origin master
          
          echo "âœ… æˆåŠŸåŒæ­¥ä¸Šæ¸¸ä»£ç å¹¶æäº¤æž„å»ºç»“æžœ"
        fi

    - name: Create release info
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        echo "## ðŸš€ è‡ªåŠ¨æž„å»ºå®Œæˆ" > release-info.md
        echo "" >> release-info.md
        echo "- **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> release-info.md
        echo "- **ä¸Šæ¸¸commit**: ${{ steps.check-changes.outputs.upstream_commit }}" >> release-info.md
        echo "- **æœ¬åœ°commit**: ${{ steps.check-changes.outputs.local_commit }}" >> release-info.md
        echo "" >> release-info.md
        echo "### ðŸ“¦ ç›®å½•è¯´æ˜Ž" >> release-info.md
        echo "- \`dist/\` - ä¸Šæ¸¸åŽŸç‰ˆæž„å»ºæ–‡ä»¶ï¼ˆä¿æŒä¸Žä¸Šæ¸¸åŒæ­¥ï¼‰" >> release-info.md
        echo "- \`build-output/\` - Forkç‰ˆæœ¬æž„å»ºæ–‡ä»¶ï¼ˆæœ¬æ¬¡CIæž„å»ºäº§ç‰©ï¼‰" >> release-info.md
        echo "" >> release-info.md
        echo "### ðŸ“„ æž„å»ºäº§ç‰© (build-output)" >> release-info.md
        if [ -d "build-output" ]; then
          for file in build-output/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "- ðŸ“„ \`$filename\` ($filesize)" >> release-info.md
            fi
          done
        fi
        echo "" >> release-info.md
        echo "### ðŸ“„ ä¸Šæ¸¸æ–‡ä»¶ (dist)" >> release-info.md
        if [ -d "dist" ]; then
          for file in dist/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "- ðŸ“„ \`$filename\` ($filesize)" >> release-info.md
            fi
          done
        fi

    - name: Upload build artifacts
      if: steps.check-changes.outputs.changes_detected == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: build-output-${{ github.run_number }}
        path: build-output/
        retention-days: 30

    - name: Summary
      run: |
        if [ "${{ steps.check-changes.outputs.changes_detected }}" == "true" ]; then
          echo "âœ… åŒæ­¥å®Œæˆï¼ä¸Šæ¸¸ä»£ç å·²æ›´æ–°å¹¶æˆåŠŸæž„å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "release-info.md" ]; then
            cat release-info.md >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°ï¼Œæ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
        fi
