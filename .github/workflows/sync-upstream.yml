name: Sync Upstream and Build

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œ (åŒ—äº¬æ—¶é—´08:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - master
    paths:
      - '.github/workflows/sync-upstream.yml'

jobs:
  sync-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up upstream remote
        run: |
          git remote add upstream https://github.com/qianjiachun/douyuEx.git || true
          git fetch upstream
          git fetch origin

      - name: Check for upstream changes
        id: check-changes
        run: |
          # èŽ·å–å½“å‰åˆ†æ”¯å’Œä¸Šæ¸¸masteråˆ†æ”¯çš„æœ€æ–°commit
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/master)
          
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°"
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°"
          fi

      - name: Sync upstream changes
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # å¤‡ä»½ build-output å’Œé‡è¦æ–‡ä»¶
          echo "ðŸ”„ å¤‡ä»½build-outputç›®å½•å’Œé‡è¦æ–‡ä»¶..."
          if [ -d "build-output" ]; then
            cp -r build-output build-output-backup
          fi
          if [ -d ".github" ]; then
            cp -r .github .github-backup
          fi
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼Œä½¿ç”¨ç­–ç•¥è‡ªåŠ¨è§£å†³distå†²çª
          echo "ðŸ”„ åˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ŒæŽ¥å—ä¸Šæ¸¸çš„distç›®å½•..."
          git merge upstream/master --no-edit --strategy-option theirs || {
            echo "âš ï¸ åˆå¹¶å†²çªï¼Œæ‰‹åŠ¨å¤„ç†..."
          
            # æŽ¥å—æ‰€æœ‰ä¸Šæ¸¸çš„distæ–‡ä»¶
            if [ -d "dist" ]; then
              git checkout --theirs dist/
              git add dist/
            fi
          
            # ä¿ç•™æˆ‘ä»¬çš„build-outputå’Œ.github
            if [ -d "build-output-backup" ]; then
              rm -rf build-output 2>/dev/null || true
              mv build-output-backup build-output
              git add build-output/
            fi
          
            if [ -d ".github-backup" ]; then
              rm -rf .github 2>/dev/null || true
              mv .github-backup .github
              git add .github/
            fi
          
            # ç»§ç»­åˆå¹¶
            git -c core.editor=true merge --continue || true
          }
          
          # æ¸…ç†å¤‡ä»½
          rm -rf build-output-backup .github-backup 2>/dev/null || true
          
          echo "âœ… æˆåŠŸåˆå¹¶ä¸Šæ¸¸æ›´æ–°"

      - name: Setup Node.js
        if: steps.check-changes.outputs.changes_detected == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: npm install

      - name: Build project
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»ºForkç‰ˆæœ¬..."
          npm run build
          
          # æ£€æŸ¥æž„å»ºæ˜¯å¦æˆåŠŸ
          if [ -d "dist" ] && [ -f "dist/douyuex.js" ]; then
            echo "âœ… æž„å»ºæˆåŠŸ"
          
            # åˆ›å»ºbuild-outputç›®å½•å¹¶å¤åˆ¶æž„å»ºç»“æžœ
            rm -rf build-output
            mkdir -p build-output
            cp -r dist/* build-output/
          
            echo "âœ… Forkæž„å»ºç»“æžœå·²ä¿å­˜åˆ°build-output/"
          
            # æ˜¾ç¤ºç›®å½•çŠ¶æ€
            echo ""
            echo "ðŸ“Š æœ€ç»ˆç›®å½•çŠ¶æ€:"
            echo "ðŸ”¸ dist/ (ä¸Šæ¸¸åŽŸç‰ˆ + æœ¬æ¬¡æž„å»º):"
            ls -lh dist/
            echo ""
            echo "ðŸ”¸ build-output/ (Forkæž„å»ºç‰ˆæœ¬å‰¯æœ¬):"
            ls -lh build-output/
          else
            echo "âŒ æž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          # è¿˜åŽŸ dist ç›®å½•çš„å˜åŒ–ï¼Œä¿æŒä¸ºä¸Šæ¸¸ç‰ˆæœ¬
          # æˆ‘ä»¬å·²ç»å°†æž„å»ºäº§ç‰©å¤åˆ¶åˆ°äº† build-outputï¼Œæ‰€ä»¥è¿™é‡Œæ¢å¤ dist
          # ä»¥é¿å…ä¸Žä¸Šæ¸¸ dist äº§ç”Ÿå†²çª
          echo "ðŸ”„ è¿˜åŽŸ dist ç›®å½•åˆ°ä¸Šæ¸¸ç‰ˆæœ¬..."
          git checkout HEAD dist/
          # å¦‚æžœæž„å»ºäº§ç”Ÿäº†æ–°çš„æœªè¿½è¸ªæ–‡ä»¶ï¼Œä¹Ÿæ¸…ç†æŽ‰
          git clean -fd dist/

          # æ·»åŠ æ‰€æœ‰æ›´æ”¹
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æž„å»ºäº§ç‰©å˜åŒ–éœ€è¦æäº¤"
          else
            # æäº¤æ›´æ”¹
            git commit -m "ðŸ¤– è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç å¹¶æž„å»º ($(date '+%Y-%m-%d %H:%M:%S'))" || true
          fi

          # æ‹‰å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹ (å…ˆæäº¤åŽæ‹‰å–ï¼Œé¿å…unstaged changesé”™è¯¯)
          # æ— è®ºæ˜¯å¦æœ‰æ–°æž„å»ºæäº¤ï¼Œéƒ½éœ€è¦æŽ¨é€åˆå¹¶çš„ä¸Šæ¸¸æ›´æ”¹
          git pull --rebase origin master || {
            echo "âš ï¸ å˜åŸºå†²çªï¼Œå°è¯•è§£å†³..."
            git rebase --abort
            git pull --no-rebase origin master
          }

          # æŽ¨é€åˆ°originï¼Œå¦‚æžœå¤±è´¥åˆ™å¼ºåˆ¶æŽ¨é€
          git push origin master || {
            echo "âš ï¸ æ™®é€šæŽ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æŽ¨é€..."
            git push --force-with-lease origin master
          }
        
          echo "âœ… æˆåŠŸåŒæ­¥ä¸Šæ¸¸ä»£ç å¹¶æäº¤æž„å»ºç»“æžœ"

      - name: Create release info
        if: steps.check-changes.outputs.changes_detected == 'true'
        run: |
          echo "## ðŸš€ è‡ªåŠ¨æž„å»ºå®Œæˆ" > release-info.md
          echo "" >> release-info.md
          echo "- **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> release-info.md
          echo "- **ä¸Šæ¸¸commit**: ${{ steps.check-changes.outputs.upstream_commit }}" >> release-info.md
          echo "" >> release-info.md
          echo "### ðŸ“¦ ç›®å½•è¯´æ˜Ž" >> release-info.md
          echo "- \`dist/\` - æœ€æ–°æž„å»ºæ–‡ä»¶ï¼ˆä¸Žä¸Šæ¸¸åŒæ­¥åŽçš„æž„å»ºç»“æžœï¼‰" >> release-info.md
          echo "- \`build-output/\` - Forkç‰ˆæœ¬æž„å»ºå‰¯æœ¬ï¼ˆå¤‡ä»½ï¼‰" >> release-info.md
          echo "" >> release-info.md
          echo "### ðŸ“„ æž„å»ºäº§ç‰©" >> release-info.md
          if [ -d "build-output" ]; then
            for file in build-output/*; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                filesize=$(du -h "$file" | cut -f1)
                echo "- ðŸ“„ \`$filename\` ($filesize)" >> release-info.md
              fi
            done
          fi

      - name: Upload build artifacts
        if: steps.check-changes.outputs.changes_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-output-${{ github.run_number }}
          path: build-output/
          retention-days: 30

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.changes_detected }}" == "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼ä¸Šæ¸¸ä»£ç å·²æ›´æ–°å¹¶æˆåŠŸæž„å»º" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f "release-info.md" ]; then
              cat release-info.md >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–°ï¼Œæ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          fi
